# ═══════════════════════════════════════════════════════════════════════════════
# T97.0: High-TPS Devnet Preset
# ═══════════════════════════════════════════════════════════════════════════════
#
# This preset enables all optimizations for maximum TPS on a devnet node:
#   - DAG primary consensus with DAG ordering enabled
#   - STM arena kernel with simple fastpath (T97.0 Arc-free handles)
#   - CUDA GPU hashing
#   - Tuned STM lanes/threads/waves for 16-core CPU
#   - High-TPS block packing (500 max tx, 1s target)
#   - Large mempool for burst handling
#   - All T82-T96 performance optimizations enabled
#
# Expected TPS: ~330-380 TPS in short burst scenarios
#
# Usage:
#   source high_tps_devnet.env
#   ./scripts/devnet_dag_primary.sh
#
# Or with the quick TPS check:
#   ./scripts/quick_tps_check.sh
#
# ═══════════════════════════════════════════════════════════════════════════════

# ───────────────────────────────────────────────────────────────────────────────
# Core Consensus Mode: DAG Primary with ordering
# ───────────────────────────────────────────────────────────────────────────────
export EEZO_CONSENSUS_MODE=dag-primary
export EEZO_DAG_ORDERING_ENABLED=1
export EEZO_DAG_PRIMARY_SHADOW_ENABLED=1
export EEZO_HYBRID_STRICT_PROFILE=1

# ───────────────────────────────────────────────────────────────────────────────
# STM Executor: Arena kernel + Simple Fastpath v2 (T87/T93/T95/T97)
# ───────────────────────────────────────────────────────────────────────────────
export EEZO_EXECUTOR_MODE=stm
export EEZO_STM_KERNEL_MODE=arena
export EEZO_STM_SIMPLE_FASTPATH_ENABLED=1
export EEZO_STM_WAVE_AGGRESSIVE=1

# ───────────────────────────────────────────────────────────────────────────────
# STM Tuning: Optimized for 16-core CPU
# ───────────────────────────────────────────────────────────────────────────────
export EEZO_EXEC_LANES=32
export EEZO_EXEC_WAVE_CAP=256
export EEZO_EXEC_BUCKETS=64
export EEZO_EXEC_HYBRID=1
export EEZO_EXEC_WAVE_COMPACT=1

# Use all available CPU cores for executor threads
export EEZO_EXECUTOR_THREADS=$(nproc 2>/dev/null || sysctl -n hw.ncpu 2>/dev/null || echo 16)
export RAYON_NUM_THREADS=$EEZO_EXECUTOR_THREADS

# ───────────────────────────────────────────────────────────────────────────────
# CUDA GPU Hashing (T90/T91)
# ───────────────────────────────────────────────────────────────────────────────
export EEZO_CUDA_HASH_ENABLED=1

# ───────────────────────────────────────────────────────────────────────────────
# Block Production: High-TPS settings
# ───────────────────────────────────────────────────────────────────────────────
export EEZO_BLOCK_MAX_TX=500
export EEZO_BLOCK_TARGET_TIME_MS=1000

# ───────────────────────────────────────────────────────────────────────────────
# Early Tick / Block Packing Optimization (T94)
# Pack blocks early when backlog is high
# ───────────────────────────────────────────────────────────────────────────────
export EEZO_EARLY_TICK_ENABLED=1
export EEZO_EARLY_TICK_THRESHOLD=100

# ───────────────────────────────────────────────────────────────────────────────
# Mempool: Large capacity for TPS bursts
# ───────────────────────────────────────────────────────────────────────────────
export EEZO_MEMPOOL_MAX_LEN=50000
export EEZO_MEMPOOL_MAX_BYTES=$((256 * 1024 * 1024))  # 256 MiB
export EEZO_MEMPOOL_RATE_CAP=100000
export EEZO_MEMPOOL_RATE_PER_MIN=600000
export EEZO_MEMPOOL_ACTOR_ENABLED=1

# ───────────────────────────────────────────────────────────────────────────────
# Performance Optimizations (T82-T84)
# ───────────────────────────────────────────────────────────────────────────────
export EEZO_PERSIST_ASYNC=1          # T83.2: Async RocksDB persistence
export EEZO_PIPELINE_ENABLED=1       # T83.3: Block execution pipelining
export EEZO_LAZY_STATE_ROOT=1        # T84.0: Deferred state root compute

# ───────────────────────────────────────────────────────────────────────────────
# Signature Verification Pool (T83.0)
# ───────────────────────────────────────────────────────────────────────────────
export EEZO_SIGPOOL_THREADS=8
export EEZO_SIGPOOL_BATCH_SIZE=128
export EEZO_SIGPOOL_QUEUE=20000

# ───────────────────────────────────────────────────────────────────────────────
# Data Directory (default for high-TPS tests)
# ───────────────────────────────────────────────────────────────────────────────
export EEZO_DATADIR=/tmp/eezo-high-tps

# ───────────────────────────────────────────────────────────────────────────────
# Network Bindings (localhost for local development)
# ───────────────────────────────────────────────────────────────────────────────
export EEZO_LISTEN=127.0.0.1:8080
export EEZO_METRICS_BIND=127.0.0.1:9898

# ───────────────────────────────────────────────────────────────────────────────
# Misc settings
# ───────────────────────────────────────────────────────────────────────────────
export EEZO_CHAIN_ID=1
export EEZO_LOG_COMMIT_EVERY=1
